import{H as A,B as R,r as v,c as m,d as $,w as H,b as y,e as h,i as g,m as U,n as N,h as d,g as E,C as T,v as F,x as b,z as q,D as J,q as M,_ as O}from"./index-DddgXWB4.js";class P{httpService;constructor(){this.httpService=A.getInstance()}async getNewsList(e=1,s=5){try{console.log("请求新闻列表:",{page:e,pageSize:s});const l=await this.httpService.get("/news",{page:e,pageSize:s});return console.log("新闻列表请求成功:",l),l}catch(l){throw console.error("获取新闻列表失败:",l),l}}async getAllNews(){try{console.log("请求所有新闻");const e=await this.httpService.get("/news/all");return console.log("所有新闻请求成功:",e),e}catch(e){throw console.error("获取所有新闻失败:",e),e}}async getNewsDetail(e){try{console.log("请求新闻详情:",e);const s=await this.httpService.get(`/news/${e}`);return console.log("新闻详情请求成功:",s),s}catch(s){throw console.error("获取新闻详情失败:",s),s}}}const V=new P,B="news_cache_data",k=300*1e3,z=()=>{try{const t=localStorage.getItem(B);if(t){const e=JSON.parse(t);if(Date.now()-e.lastFetched<k)return e}}catch(t){console.error("Failed to load news from cache:",t)}return null},K=t=>{try{localStorage.setItem(B,JSON.stringify(t))}catch(e){console.error("Failed to save news to cache:",e)}},ae=R("News",()=>{const t=v([]),e=v(!1),s=v(null),l=v(1),w=v(5),i=v(0),u=v(0),S=m(()=>t.value.length<i.value),p=m(()=>u.value>0&&Date.now()-u.value<k),o=z();o&&(t.value=o.newsList,i.value=o.totalNews,u.value=o.lastFetched);const n=async()=>{if(p.value&&t.value.length>0){console.log("使用有效的缓存数据");return}e.value=!0,s.value=null;try{const a=await V.getAllNews();t.value=a,i.value=a.length,u.value=Date.now(),K({newsList:t.value,totalNews:i.value,lastFetched:u.value})}catch(a){s.value=a instanceof Error?a.message:"获取新闻失败",console.error("Failed to fetch all news:",a)}finally{e.value=!1}},f=async(a=1,r=5)=>{e.value=!0,s.value=null;try{const c=await V.getNewsList(a,r);if(a===1)t.value=c.data;else{const I=new Set(t.value.map(L=>L.id)),x=c.data.filter(L=>!I.has(L.id));t.value=[...t.value,...x]}l.value=a,w.value=r,i.value=c.total}catch(c){s.value=c instanceof Error?c.message:"获取新闻列表失败",console.error(`Failed to fetch news page ${a}:`,c)}finally{e.value=!1}},D=async a=>{e.value=!0,s.value=null;try{const r=await V.getNewsDetail(a);if(r){const c=t.value.findIndex(I=>I.id===a);return c===-1?t.value=[r,...t.value]:t.value[c]=r,r}return null}catch(r){return s.value=r instanceof Error?r.message:"获取新闻详情失败",console.error(`Failed to fetch news with id ${a}:`,r),null}finally{e.value=!1}},C=()=>{t.value=[],e.value=!1,s.value=null,l.value=1,i.value=0},_=m(()=>a=>t.value.find(r=>r.id===a)||null);return{newsList:t,loading:e,error:s,currentPage:l,pageSize:w,totalNews:i,lastFetched:u,hasMore:S,isCacheValid:p,getNewsById:_,fetchAllNews:n,fetchNewsList:f,fetchNewsById:D,resetState:C,refreshNews:async()=>{await f(1,w.value)}}}),X={key:0,class:"loading-container"},Y={key:1,class:"dialog-content"},j={class:"media-container"},G=["src"],Q=["src","poster"],W={class:"text-container"},Z={class:"news-text"},ee={key:2,class:"error-container"},te={class:"dialog-footer"},se=$({__name:"newsDialog",props:{DialogVisible:{type:Boolean},currentNews:{},isLoading:{type:Boolean,default:!1}},emits:["close"],setup(t,{emit:e}){const s=v(null),l=t,w=m(()=>{if(!l.currentNews?.imgUrl)return"";try{return new URL(l.currentNews.imgUrl,"http://localhost:5173/src/assets/newsImg/").href}catch(o){return console.error("构建图片URL失败:",o),""}}),i=m(()=>{if(!l.currentNews?.videoUrl)return"";try{return new URL(l.currentNews.videoUrl,"http://localhost:5173/src/assets/newsImg/").href}catch(o){return console.error("构建视频URL失败:",o),""}});H(()=>l.DialogVisible,o=>{o&&s.value&&setTimeout(()=>{},100)});const u=e,S=()=>{u("close")},p=o=>{const n=document.querySelector("video.media");n&&n.pause(),o()};return(o,n)=>{const f=U("el-icon"),D=U("el-button"),C=U("el-dialog");return N(),y("div",null,[h(C,{modelValue:l.DialogVisible,"onUpdate:modelValue":n[0]||(n[0]=_=>l.DialogVisible=_),title:o.currentNews?.title||"加载中...",width:"80vw","align-center":"",center:"",ref_key:"dialog",ref:s,onClose:n[1]||(n[1]=_=>o.$emit("close")),"header-class":"header","before-close":p},{footer:g(()=>[d("div",te,[h(D,{onClick:S},{default:g(()=>n[4]||(n[4]=[M("返回",-1)])),_:1,__:[4]})])]),default:g(()=>[o.isLoading?(N(),y("div",X,[h(f,null,{default:g(()=>[h(E(T))]),_:1}),n[2]||(n[2]=d("span",null,"正在加载新闻详情...",-1))])):o.currentNews?(N(),y("div",Y,[d("div",j,[F(d("img",{src:w.value,alt:"新闻图片",class:"media",loading:"lazy"},null,8,G),[[b,o.currentNews.type==="img"]]),F(d("video",{src:i.value,class:"media",poster:w.value,controls:"",playsinline:"",preload:"metadata"},null,8,Q),[[b,o.currentNews.type==="video"]])]),d("div",W,[d("p",Z,q(o.currentNews.text),1)])])):(N(),y("div",ee,[h(f,null,{default:g(()=>[h(E(J))]),_:1}),n[3]||(n[3]=d("span",null,"无法加载新闻内容，请稍后重试",-1))]))]),_:1},8,["modelValue","title"])])}}}),ne=O(se,[["__scopeId","data-v-bf7837f2"]]);export{ne as n,ae as u};
